SELECT TO_CHAR(BIG_TABLE.ADM_DATE,'DD-MON-RR') ADM_DATE, BIG_TABLE.SCHEDULE_TIME, BIG_TABLE.PATIENT_DATA, BIG_TABLE.DEPTS_ID, BIG_TABLE.DEPTS_NAME, PATIENT.PAT_NAME, PATIENT.SUBCODE PAT_CODE,
       CASE WHEN MY_TO_NUMBER(PATIENT_DATA) = 1 THEN GET_AGE(PATIENT_DATA, BIG_TABLE.ADM_DATE) ELSE NULL END PAT_AGE_NOW,
       PFN_DATA.PFN_FEE_NAME, BIG_TABLE.DOC_VIDEO_LINK, BIG_TABLE.TS_VIDEO_CONF_FLAG, NVL(PMM_DATA.PMM,0) PMM,
       GET_PROGRESS_BY_AD_ID(PFN_DATA.AD_ID) IS_RANKED, 
       CASE WHEN MY_TO_NUMBER(PATIENT_DATA) = 1 THEN GET_PAT_PROGRESS_BY_PH_PFN_ID(BIG_TABLE.PATIENT_DATA,PFN_DATA.PFN_ID) ELSE NULL END PPH_PROGRESS,
       CASE WHEN MY_TO_NUMBER(PATIENT_DATA) = 1 AND BIG_TABLE.PATIENT_DATA IS NOT NULL 
       THEN GET_CATEGORY_ID_BY_PH_ID (BIG_TABLE.PATIENT_DATA) ELSE NULL END PH_CAT_ID, PFN_DATA.PFN_ID,
       PFN_DATA.AD_ID, PFN_DATA.AD_PRM_ID, PFN_DATA.AD_PRD_ID

FROM (SELECT DISTINCT DOCTOR_INFO.DOC_NAME, TO_CHAR(TIME_SCHEDULING.TS_SCHEDULE, 'HH:MI AM') SCHEDULE_TIME, 
            TO_DATE(TO_CHAR(TIME_SCHEDULING.TS_SCHEDULE, 'HH:MI AM'), 'HH:MI AM') SCHEDULE, 
            DOCTOR_INFO.DOC_VIDEO_LINK, TIME_SCHEDULING.TS_VIDEO_CONF_FLAG,
            DEPARTMENT_SLV.DEPTS_NAME,DEPARTMENT_SLV.DEPTS_ID, APPOINTMENT_MST.AM_ID, 
            TIME_SCHEDULING.TS_ID,APPOINTMENT_DATE_MST.ADM_DATE,APPOINTMENT_MST.AM_DOC_ID,DOCTOR_INFO.DOC_SEX,
            GET_PAITENT_SCHEDULE_DATA(TIME_SCHEDULING.TS_ID,APPOINTMENT_MST.AM_ID,
            DOCTOR_INFO.DOC_ID,DEPARTMENT_SLV.DEPTS_ID,APPOINTMENT_DATE_MST.ADM_DATE) PATIENT_DATA
      FROM APPOINTMENT_MST, APPOINTMENT_DATE_MST, TIME_SCHEDULING, DOCTOR_INFO, DEPARTMENT_SLV
      WHERE TRUNC(APPOINTMENT_DATE_MST.ADM_DATE) = TO_DATE(:pdate,'dd-MON-yy')
        AND ((APPOINTMENT_MST.AM_ADM_ID (+)= APPOINTMENT_DATE_MST.ADM_ID)
        AND (APPOINTMENT_MST.AM_DOC_ID = DOCTOR_INFO.DOC_ID(+))
        AND (DEPARTMENT_SLV.DEPTS_ID (+)= APPOINTMENT_MST.AM_DEPTS_ID)
        AND (DEPARTMENT_SLV.DEPTS_ID = TIME_SCHEDULING.TS_DEPTS_ID (+)))
        AND TIME_SCHEDULING.TS_SCHEDULE_QUIT<>1
        AND DOCTOR_INFO.DOC_ID = :doc_id
      ORDER BY DOCTOR_INFO.DOC_NAME, SCHEDULE, APPOINTMENT_DATE_MST.ADM_DATE asc) BIG_TABLE, 

    (SELECT PATIENT_INFO.PAT_PH_ID, GET_PH_SUBCODE(PAT_PH_ID) SUBCODE, PATIENT_INFO.PAT_NAME FROM PATIENT_INFO) PATIENT,

    (SELECT APPOINTMENT_DTL.AD_AM_ID,appointment_schedule.as_ts_id, payment_fee_name.pfn_fee_name, 
     appointment_schedule.as_id, PAYMENT_FEE_NAME.PFN_ID,APPOINTMENT_DTL.AD_PRM_ID,
     APPOINTMENT_DTL.AD_PRD_ID,APPOINTMENT_DTL.AD_ID
    FROM APPOINTMENT_SCHEDULE, APPOINTMENT_DTL, PAYMENT_FEE_NAME,TIME_SCHEDULING
    WHERE PAYMENT_FEE_NAME.PFN_ID = APPOINTMENT_DTL.AD_PFN_ID
    AND APPOINTMENT_DTL.AD_ID = APPOINTMENT_SCHEDULE.AS_AD_ID
    AND TIME_SCHEDULING.TS_ID = APPOINTMENT_SCHEDULE.AS_TS_ID
    AND NVL(APPOINTMENT_DTL.AD_CANCEL,0) = 0) PFN_DATA,

    (SELECT COUNT(*) PMM , PMM_PH_ID FROM PATIENT_MDT_MST GROUP BY PMM_PH_ID) PMM_DATA

WHERE CASE WHEN MY_TO_NUMBER(BIG_TABLE.PATIENT_DATA) = 1 THEN BIG_TABLE.PATIENT_DATA ELSE NULL END = PATIENT.PAT_PH_ID (+)
AND CASE WHEN MY_TO_NUMBER(BIG_TABLE.PATIENT_DATA) = 1 THEN BIG_TABLE.PATIENT_DATA ELSE NULL END = PMM_DATA.PMM_PH_ID (+)
AND BIG_TABLE.AM_ID = PFN_DATA.AD_AM_ID (+)
AND PFN_DATA.as_ts_id (+) = BIG_TABLE.TS_ID
ORDER BY BIG_TABLE.SCHEDULE asc
