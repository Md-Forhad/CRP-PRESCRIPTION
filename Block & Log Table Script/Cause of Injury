--Cause of injury
ALTER TABLE INJURY_MST_BLOCK DROP PRIMARY KEY CASCADE;

DROP TABLE INJURY_MST_BLOCK CASCADE CONSTRAINTS;

CREATE TABLE INJURY_MST_BLOCK (
  IMB_ID                 NUMBER(20)              NOT NULL,
  IMB_INJURY_ID          NUMBER(10),
  IMB_DOC_ID             NUMBER(20),
  IMB_CID_ID             NUMBER(10),
  IMB_ENTRY_BY           VARCHAR2(30),
  IMB_ENTRY_TIME         DATE DEFAULT SYSDATE
);

CREATE UNIQUE INDEX INJURY_MST_BLOCK_PK ON INJURY_MST_BLOCK (IMB_ID);

CREATE OR REPLACE TRIGGER INJURY_BLOCK_PRE_INSERT
BEFORE INSERT ON INJURY_MST_BLOCK
REFERENCING OLD AS OLD NEW AS NEW
FOR EACH ROW
BEGIN
    SELECT NVL(MAX(IMB_ID),0) + 1
    INTO :NEW.IMB_ID
    FROM INJURY_MST_BLOCK;
END;
/

-----------------------------------LOG START------------------------------------
ALTER TABLE INJURY_MST_BLOCK_LOG DROP PRIMARY KEY CASCADE;

DROP TABLE INJURY_MST_BLOCK_LOG CASCADE CONSTRAINTS;

CREATE TABLE INJURY_MST_BLOCK_LOG (
  IMB_LOG_ID             NUMBER           NOT NULL,
  IMB_ID                 NUMBER(20),
  IMB_INJURY_ID          NUMBER(10),
  IMB_DOC_ID             NUMBER(20),
  IMB_CID_ID             NUMBER(10),
  IMB_ENTRY_BY           VARCHAR2(30),
  IMB_ENTRY_TIME         DATE,
  IMB_LOG_TIME           VARCHAR2(30),
  IMB_LOG_STATUS         VARCHAR2(10)
);

CREATE UNIQUE INDEX INJURY_MST_BLOCK_LOG_PK ON INJURY_MST_BLOCK_LOG (IMB_LOG_ID);

CREATE OR REPLACE TRIGGER INJURY_BLOCK_LOG_PRE_INS
BEFORE INSERT ON INJURY_MST_BLOCK_LOG
REFERENCING OLD AS OLD NEW AS NEW
FOR EACH ROW
BEGIN
    SELECT NVL(MAX(IMB_LOG_ID),0) + 1
    INTO :NEW.IMB_LOG_ID
    FROM INJURY_MST_BLOCK_LOG;
END;
/

ALTER TABLE INJURY_MST_BLOCK_LOG ADD (
  CONSTRAINT INJURY_MST_BLOCK_LOG_PK PRIMARY KEY (IMB_LOG_ID)
  USING INDEX INJURY_MST_BLOCK_LOG_PK ENABLE VALIDATE);
---------------------------------------LOG END----------------------------------


CREATE OR REPLACE TRIGGER INJURY_BLOCK_AUDIT
BEFORE INSERT OR UPDATE OR DELETE
ON INJURY_MST_BLOCK
REFERENCING OLD AS OLD NEW AS NEW
FOR EACH ROW
DECLARE
    STATUS VARCHAR2(10);
BEGIN
    IF INSERTING OR UPDATING THEN
        IF INSERTING THEN STATUS := 'INSERT';
        ELSIF UPDATING THEN STATUS := 'UPDATE';
        END IF;
		
        INSERT INTO INJURY_MST_BLOCK_LOG (IMB_ID, 
                                          IMB_INJURY_ID, 
                                          IMB_DOC_ID, 
                                          IMB_CID_ID, 
                                          IMB_ENTRY_BY, 
                                          IMB_ENTRY_TIME, 
                                          IMB_LOG_TIME, 
                                          IMB_LOG_STATUS)
        VALUES (:NEW.IMB_ID, 
                :NEW.IMB_INJURY_ID, 
                :NEW.IMB_DOC_ID, 
                :NEW.IMB_CID_ID, 
                :NEW.IMB_ENTRY_BY, 
                :NEW.IMB_ENTRY_TIME, 
                TO_CHAR(SYSDATE,'DD/MM/RRRR HH12:MI:SS AM'),
                STATUS);
    ELSE
        STATUS := 'DELETE';
        INSERT INTO INJURY_MST_BLOCK_LOG (IMB_ID, 
                                          IMB_INJURY_ID, 
                                          IMB_DOC_ID, 
                                          IMB_CID_ID, 
                                          IMB_ENTRY_BY, 
                                          IMB_ENTRY_TIME, 
                                          IMB_LOG_TIME, 
                                          IMB_LOG_STATUS)
        VALUES (:OLD.IMB_ID, 
                :OLD.IMB_INJURY_ID, 
                :OLD.IMB_DOC_ID, 
                :OLD.IMB_CID_ID, 
                :OLD.IMB_ENTRY_BY, 
                :OLD.IMB_ENTRY_TIME, 
                TO_CHAR(SYSDATE,'DD/MM/RRRR HH12:MI:SS AM'), 
                STATUS);
    END IF;
END;
/

ALTER TABLE INJURY_MST_BLOCK ADD (
  CONSTRAINT INJURY_MST_BLOCK_PK PRIMARY KEY (IMB_ID)
  USING INDEX INJURY_MST_BLOCK_PK ENABLE VALIDATE);
